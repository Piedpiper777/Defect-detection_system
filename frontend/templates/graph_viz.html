{% extends "base.html" %}

{% block title %}Neo4j图可视化 - 工业大模型知识问答系统{% endblock %}

{% block extra_css %}
<style>
#viz {
    width: 100%;
    height: 600px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f8f9fa;
}

.viz-container {
    margin: 20px 0;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.viz-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.btn-viz {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    background: #2F80ED;
    color: white;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
}

.btn-viz:hover {
    background: #2563eb;
}

.btn-viz.secondary {
    background: #6b7280;
}

.btn-viz.secondary:hover {
    background: #4b5563;
}

.query-input {
    flex: 1;
    min-width: 300px;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
}

.query-input:focus {
    outline: none;
    border-color: #2F80ED;
    box-shadow: 0 0 0 3px rgba(47, 128, 237, 0.1);
}

.status-message {
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 10px;
    display: none;
}

.status-message.success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

.status-message.error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- 页面标题 -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">Neo4j图数据库可视化</h1>
            <p class="page-subtitle">使用Neovis.js进行图数据可视化展示</p>
        </div>
    </div>

    <!-- 可视化容器 -->
    <div class="viz-container">
        <!-- 控制面板 -->
        <div class="viz-controls">
            <input type="text" id="cypherQuery" class="query-input" placeholder="输入Cypher查询语句..." value="MATCH (n)-[r]->(m) RETURN n,r,m LIMIT 50">
            <button id="runQuery" class="btn-viz">执行查询</button>
            <button id="resetView" class="btn-viz secondary">重置视图</button>
            <button id="fitView" class="btn-viz secondary">适应屏幕</button>
        </div>

        <!-- 状态消息 -->
        <div id="statusMessage" class="status-message"></div>

        <!-- 可视化画布 -->
        <div id="viz"></div>
    </div>

    <!-- 使用说明 -->
    <div class="viz-container">
        <h3>使用说明</h3>
        <ul>
            <li><strong>执行查询：</strong>在输入框中输入Cypher查询语句，点击"执行查询"按钮</li>
            <li><strong>交互操作：</strong>可以拖拽节点、缩放视图、点击节点查看详情</li>
            <li><strong>示例查询：</strong></li>
            <ul>
                <li><code>MATCH (n)-[r]->(m) RETURN n,r,m LIMIT 50</code> - 查看所有节点和关系</li>
                <li><code>MATCH (n:Person) RETURN n</code> - 查看Person类型的节点</li>
                <li><code>MATCH (n)-[r:FRIEND]->(m) RETURN n,r,m</code> - 查看特定关系</li>
            </ul>
        </ul>
    </div>
</div>

{% block extra_js %}
<!-- Neovis.js 库 -->
<script src="https://cdn.jsdelivr.net/npm/neovis.js@2.0.2/dist/neovis.js"></script>

<script>
// 配置Neovis.js
let viz;
const config = {
    containerId: "viz",
    neo4j: {
        serverUrl: "bolt://localhost:7687",
        serverUser: "neo4j",
        serverPassword: "detectneo4j"
    },
    visConfig: {
        nodes: {
            shape: "dot",
            size: 28,
            font: {
                size: 14,
                color: "#222222"
            },
            borderWidth: 2
        },
        edges: {
            arrows: {
                to: { enabled: true, scaleFactor: 0.5 }
            },
            font: {
                size: 12,
                align: "middle"
            }
        },
        physics: {
            enabled: true,
            barnesHut: {
                gravitationalConstant: -8000,
                centralGravity: 0.3,
                springLength: 95,
                springConstant: 0.04,
                damping: 0.09,
                avoidOverlap: 0
            }
        },
        interaction: {
            hover: true,
            selectConnectedEdges: true,
            multiselect: true
        }
    },
    // 按实际标签名显式配置：每种节点都用属性 name 作为显示文字
    labels: {
        "DetectObject   ": { label: "name" },
        "DefectType": { label: "name" },
        "Cause": { label: "name" },
        "Solution": { label: "name" }
    },
    // 关系暂不配置文字（先保证节点文字正常显示）
    relationships: {},
    initialCypher: "MATCH (n)-[r]->(m) RETURN n,r,m LIMIT 25"
};

// 初始化可视化
function initViz() {
    try {
        viz = new NeoVis.default(config);
        viz.render();
        showStatus("可视化初始化成功", "success");
    } catch (error) {
        showStatus("可视化初始化失败: " + error.message, "error");
        console.error("Neovis initialization error:", error);
    }
}

// 显示状态消息
function showStatus(message, type) {
    const statusDiv = document.getElementById("statusMessage");
    statusDiv.textContent = message;
    statusDiv.className = `status-message ${type}`;
    statusDiv.style.display = "block";

    // 3秒后自动隐藏
    setTimeout(() => {
        statusDiv.style.display = "none";
    }, 3000);
}

// 执行自定义查询
function runCustomQuery() {
    const queryInput = document.getElementById("cypherQuery");
    const query = queryInput.value.trim();

    if (!query) {
        showStatus("请输入查询语句", "error");
        return;
    }

    try {
        if (viz) {
            viz.clearNetwork(); // 清除当前图
        }

        // 重新配置查询
        config.initialCypher = query;
        viz = new NeoVis.default(config);
        viz.render();

        showStatus("查询执行成功", "success");
    } catch (error) {
        showStatus("查询执行失败: " + error.message, "error");
        console.error("Query execution error:", error);
    }
}

// 重置视图
function resetView() {
    if (viz && viz.network) {
        viz.network.fit();
        showStatus("视图已重置", "success");
    }
}

// 适应屏幕
function fitView() {
    if (viz && viz.network) {
        viz.network.fit({
            animation: {
                duration: 1000,
                easingFunction: "easeInOutQuad"
            }
        });
        showStatus("视图已适应屏幕", "success");
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 绑定事件监听器
    document.getElementById('runQuery').addEventListener('click', runCustomQuery);
    document.getElementById('resetView').addEventListener('click', resetView);
    document.getElementById('fitView').addEventListener('click', fitView);

    // 支持回车键执行查询
    document.getElementById('cypherQuery').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            runCustomQuery();
        }
    });

    // 初始化可视化
    setTimeout(initViz, 1000); // 延迟初始化，确保DOM加载完成
});
</script>
{% endblock %}
{% endblock %}