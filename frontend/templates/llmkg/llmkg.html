{% extends "base.html" %}

{% block title %}问答与图谱可视化 - 工业缺陷检测智能系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/llmkg.css') }}">
{% endblock %}

{% block content %}
<script id="neo4j-config" type="application/json">
    {{ neo4j_config | default({'serverUrl': 'bolt://localhost:7687', 'serverUser': 'neo4j', 'serverPassword': 'neo4j'}) | tojson | safe }}
</script>
<div class="content-wrapper">
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">缺陷检测问答</h1>
            <p class="page-subtitle">基于大模型与多源数据库的缺陷检测知识问答</p>
        </div>
    </div>

    <div class="split-layout">
        <!-- 左侧：会话列表侧边栏 -->
        <div class="conversations-sidebar">
            <div class="sidebar-header">
                <button id="newConversationBtn" class="new-conversation-btn">
                    <i class="fas fa-plus"></i> 新建对话
                </button>
            </div>
            <div class="conversations-list" id="conversationsList">
                <!-- 会话列表将在这里动态生成 -->
            </div>
        </div>

        <!-- 中间：问答 -->
        <div class="card-panel qa-wrapper">
            <div class="panel-header">
                <h3 id="conversationTitle"><i class="fas fa-comments" style="margin-right:8px;color:#2F80ED;"></i>问答助手</h3>
                <div class="panel-actions">
                    <button id="memoryUpdateBtn" class="btn-viz secondary small" title="记忆更新">
                        <i class="fas fa-memory"></i> 记忆更新
                    </button>
                    <button id="renameConversationBtn" class="btn-viz secondary small" title="重命名对话">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button id="deleteConversationBtn" class="btn-viz secondary small" title="删除对话">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="chat-history" id="chatHistory">
                <div class="welcome-message">
                    <div class="bot-avatar"><i class="fas fa-robot"></i></div>
                    <div class="message-content">
                        <p>您好！这里可以提问缺陷检测相关的问题，同时在右侧查看图谱上下文。</p>
                        <p>输入问题并发送，我会基于知识库给出回答。</p>
                    </div>
                </div>
            </div>

            <!-- 检索结果展示 -->
            <div class="card-panel retrieval-panel" style="margin-top: 12px;">
                <div class="panel-header">
                    <h3><i class="fas fa-search" style="margin-right:8px;color:#2F80ED;"></i>检索到的信息</h3>
                    <div class="panel-actions">
                        <button id="openRetrievalModalHeader" class="btn-viz secondary small" style="display:none">查看全部</button>
                    </div>
                </div>
                <div class="retrieval-content" id="retrievalContent">
                    <p class="muted">暂无检索结果，若为空将基于通用知识回答。</p>
                </div>
                <!-- Modal for full retrieval list -->
                <div id="retrievalModal" class="retrieval-modal" aria-hidden="true">
                    <div class="modal-overlay" id="retrievalModalOverlay"></div>
                    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="retrievalModalTitle">
                        <div class="modal-header">
                            <h3 id="retrievalModalTitle">检索结果</h3>
                            <div class="modal-actions">
                                <button id="closeRetrievalModal" class="btn-viz small">关闭</button>
                            </div>
                        </div>
                        <div class="modal-body" id="retrievalModalBody"></div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <textarea id="questionInput" placeholder="请输入您关于缺陷检测的问题..." rows="3" maxlength="1000"></textarea>
                    <div class="input-controls">
                        <div class="char-count"><span id="charCount">0</span>/1000</div>
                        <button id="sendButton" class="send-btn" disabled><i class="fas fa-paper-plane"></i>发送</button>
                    </div>
                </div>
            </div>

            <!-- 记忆更新确认按钮区域 -->
            <div id="memoryUpdateControls" style="display:none; padding: 12px; background: var(--card-bg); border-top: 1px solid var(--border); border-radius: 0 0 12px 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>已选择 <span id="selectedCount">0</span> 条消息</span>
                    <div style="display: flex; gap: 8px;">
                        <button id="memoryUpdateConfirmSelectionBtn" class="btn-viz">确定</button>
                        <button id="memoryUpdateCancelSelectionBtn" class="btn-viz secondary">取消</button>
                    </div>
                </div>
            </div>

            <div class="loading-indicator" id="loadingIndicator">
                <div class="spinner"></div><span>正在思考中...</span>
            </div>
        </div>

        <!-- 记忆更新弹窗 -->
        <div id="memoryUpdateModal" class="memory-modal" aria-hidden="true">
            <div class="modal-overlay" id="memoryModalOverlay"></div>
            <div class="modal-content" role="dialog" aria-modal="true">
                <div class="modal-header">
                    <h3 id="memoryModalTitle">记忆更新</h3>
                    <button id="closeMemoryModal" class="btn-close">&times;</button>
                </div>
                <div class="modal-body" id="memoryModalBody">
                    <div id="memoryProcessingState" style="display:none;">
                        <div class="spinner"></div>
                        <p>正在处理中，请稍候...</p>
                    </div>
                    <div id="memoryResultState" style="display:none;">
                        <div class="memory-summary">
                            <h4>总结内容：</h4>
                            <div id="memorySummaryContent" class="memory-content"></div>
                        </div>
                        <div class="memory-actions">
                            <button id="memoryUpdateConfirmBtn" class="btn-viz">更新</button>
                            <button id="memoryUpdateCancelBtn" class="btn-viz secondary">取消</button>
                        </div>
                    </div>
                    <div id="memoryUpdateResultState" style="display:none;">
                        <div class="memory-update-result">
                            <div class="result-header">
                                <h4>更新结果</h4>
                            </div>
                            <div class="result-content">
                                <div class="result-item">
                                    <span class="result-label">关系类型：</span>
                                    <span id="memoryRelationshipType" class="result-value"></span>
                                </div>
                                <div class="result-item">
                                    <span class="result-label">处理结果：</span>
                                    <span id="memoryUpdateMessage" class="result-value"></span>
                                </div>
                            </div>
                            <div class="memory-actions">
                                <button id="memoryUpdateCloseBtn" class="btn-viz">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：图谱 + 文本（并列卡片） -->
        <div class="right-column">
            <div class="card-panel graph-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-project-diagram" style="margin-right:8px;color:#2F80ED;"></i>知识图谱</h3>
                </div>

                <div class="viz-controls">
                    <input type="text" id="cypherQuery" class="query-input" value="MATCH (n)-[r]->(m) RETURN n,r,m LIMIT 100" placeholder="输入Cypher查询语句...">
                    <button id="runQuery" class="btn-viz">执行查询</button>
                    <button id="resetView" class="btn-viz secondary">重置视图</button>
                    <button id="fitView" class="btn-viz secondary">适应屏幕</button>
                    <button id="refreshSchema" class="btn-viz secondary">更新Schema</button>
                </div>

                <div id="statusMessage" class="status-message"></div>
                <div id="viz"></div>
            </div>

            <div class="card-panel text-db-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-book" style="margin-right:8px;color:#2F80ED;"></i>文本数据库</h3>
                    <div class="panel-actions">                        <input type="text" id="textDbFilter" class="query-input" placeholder="按关键词筛选文本..." aria-label="筛选文本">                        <button id="refreshTextDb" class="btn-viz secondary">刷新文本</button>
                    </div>
                </div>
                <div class="text-db-content" id="textDb" aria-live="polite">
                    <p class="muted">正在加载…</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/neovis.js@2.0.2/dist/neovis.js"></script>
<script src="{{ url_for('static', filename='js/llmkg.js') }}"></script>
{% endblock %}